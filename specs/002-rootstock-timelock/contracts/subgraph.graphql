# Rootstock Timelock Management - The Graph Subgraph Schema
# Indexes TimelockController events: CallScheduled, CallExecuted, Cancelled, RoleGranted, RoleRevoked

type Operation @entity(immutable: true) {
  id: Bytes!                    # Operation hash (bytes32)
  index: BigInt!                # Sequential index for sorting (blockNumber * 1000000 + logIndex)
  timelockController: Bytes!    # TimelockController contract address

  # Single call data (for schedule())
  target: Bytes                 # Target contract (null for batch)
  value: BigInt                 # Value in wei (null for batch)
  data: Bytes                   # Encoded calldata (null for batch)

  # Timelock parameters
  predecessor: Bytes!           # bytes32 predecessor hash
  salt: Bytes!                  # bytes32 salt
  delay: BigInt!                # Delay in seconds
  timestamp: BigInt!            # Ready timestamp (block.timestamp + delay)

  # Status tracking
  status: OperationStatus!      # PENDING, READY, EXECUTED, CANCELLED

  # Event metadata
  scheduledAt: BigInt!          # Block timestamp when scheduled
  scheduledTx: Bytes!           # Transaction hash
  scheduledBy: Bytes!           # Proposer address
  executedAt: BigInt            # Block timestamp when executed
  executedTx: Bytes             # Transaction hash
  executedBy: Bytes             # Executor address
  cancelledAt: BigInt           # Block timestamp when cancelled
  cancelledTx: Bytes            # Transaction hash
  cancelledBy: Bytes            # Canceller address

  # Relationships
  calls: [Call!]! @derivedFrom(field: "operation")
}

type Call @entity(immutable: true) {
  id: Bytes!                    # Composite: operationId-index
  operation: Operation!         # Parent operation
  index: Int!                   # Index within batch (from CallScheduled event)
  target: Bytes!                # Target contract address
  value: BigInt!                # Value in wei
  data: Bytes!                  # Encoded function call data
  signature: String             # Decoded function signature (optional, if ABI known)
}

type Role @entity {
  id: Bytes!                    # Role hash (bytes32)
  roleHash: Bytes!              # Same as id, for convenience
  timelockController: Bytes!    # TimelockController contract address
  adminRole: Role               # Admin role that can grant/revoke this role
  memberCount: Int!             # Current number of members (updated on grant/revoke)

  # Relationships
  assignments: [RoleAssignment!]! @derivedFrom(field: "role")
}

type RoleAssignment @entity(immutable: true) {
  id: Bytes!                    # Composite: roleHash-account-txHash
  role: Role!                   # Parent role
  account: Bytes!               # Account address
  granted: Boolean!             # true = granted, false = revoked
  timestamp: BigInt!            # Block timestamp
  blockNumber: BigInt!          # Block number
  txHash: Bytes!                # Transaction hash
  sender: Bytes!                # Address that granted/revoked the role
}

type TimelockController @entity {
  id: Bytes!                    # Contract address
  address: Bytes!               # Same as id
  minDelay: BigInt!             # Current minimum delay (can change)
  operationCount: Int!          # Total operations scheduled

  # Relationships
  operations: [Operation!]! @derivedFrom(field: "timelockController")
  roles: [Role!]! @derivedFrom(field: "timelockController")
}

enum OperationStatus {
  PENDING      # Scheduled but timestamp not reached
  READY        # Timestamp reached, executable
  EXECUTED     # Successfully executed
  CANCELLED    # Cancelled before execution
}
